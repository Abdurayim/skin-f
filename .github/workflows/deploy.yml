name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_backend_check:
        description: 'Skip backend API compatibility check (use when backend is not yet deployed)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate Environment Variables
        run: |
          echo "Checking environment variables..."
          if [ -z "${{ vars.VITE_API_BASE_URL }}" ]; then
            echo "ERROR: VITE_API_BASE_URL is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions > Variables"
            exit 1
          fi
          if [ -z "${{ vars.VITE_GOOGLE_CLIENT_ID }}" ]; then
            echo "ERROR: VITE_GOOGLE_CLIENT_ID is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions > Variables"
            exit 1
          fi
          echo "VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}"
          echo "VITE_GOOGLE_CLIENT_ID is set"

          # Check if API URL is not localhost
          if echo "${{ vars.VITE_API_BASE_URL }}" | grep -q "localhost"; then
            echo "ERROR: API URL contains 'localhost' - this will fail in production!"
            echo "Expected format: https://api.skintrader.uz/api"
            exit 1
          fi
          echo "Environment variables validated"

      - name: Check for Common Code Issues
        run: |
          echo "Checking for potential code issues..."

          # Check for hardcoded localhost URLs (excluding api.js fallback and logger)
          LOCALHOST_HITS=$(grep -r "localhost" src/ --include="*.jsx" --include="*.js" \
            -l 2>/dev/null | grep -v "api.js" | grep -v "logger.js" || true)
          if [ -n "$LOCALHOST_HITS" ]; then
            echo "ERROR: Found hardcoded localhost URLs in:"
            echo "$LOCALHOST_HITS"
            exit 1
          fi

          echo "Code quality checks passed"

      - name: Build
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}

      - name: Verify Build Output
        run: |
          echo "Checking build output..."
          ls -la dist/

          echo "Verifying critical files exist..."
          test -f dist/index.html || { echo "ERROR: index.html missing"; exit 1; }
          test -f dist/404.html || { echo "ERROR: 404.html missing"; exit 1; }

          # _redirects and .htaccess are optional depending on hosting
          if [ -f dist/_redirects ]; then echo "_redirects: present"; fi
          if [ -f dist/.htaccess ]; then echo ".htaccess: present"; fi

          echo "Checking bundle size..."
          JS_FILE=$(find dist/assets -name "*.js" -type f | head -1)
          if [ -n "$JS_FILE" ]; then
            JS_BYTES=$(stat -c%s "$JS_FILE" 2>/dev/null || stat -f%z "$JS_FILE" 2>/dev/null || echo "0")
            echo "JavaScript bundle: ${JS_BYTES} bytes"
            if [ "$JS_BYTES" -gt 1048576 ]; then
              echo "WARNING: JavaScript bundle is large (>1MB). Consider code splitting."
            fi
          fi

          # Verify root div exists
          if ! grep -q '<div id="root">' dist/index.html; then
            echo "ERROR: index.html missing root div"
            exit 1
          fi

          echo "Build output verified"

      - name: Verify SPA Routing Configuration
        run: |
          echo "Verifying SPA routing files..."

          # Check _redirects content (for Netlify/Cloudflare)
          if [ -f dist/_redirects ]; then
            if grep -q "/\*.*index.html.*200" dist/_redirects; then
              echo "_redirects SPA rule: OK"
            else
              echo "WARNING: _redirects missing SPA rule"
            fi
          fi

          # Check 404.html has redirect script (for GitHub Pages)
          if [ -f dist/404.html ]; then
            if grep -q "window.location\|sessionStorage" dist/404.html; then
              echo "404.html redirect script: OK"
            else
              echo "WARNING: 404.html missing redirect script"
            fi
          fi

          echo "SPA routing configuration verified"

      - name: Validate API Configuration in Build
        run: |
          echo "Validating API configuration in built files..."

          JS_FILE=$(find dist/assets -name "index-*.js" -type f | head -1)

          if [ -z "$JS_FILE" ]; then
            echo "ERROR: Could not find built JavaScript file"
            exit 1
          fi

          # Verify env vars were replaced at build time
          if grep -q "import\.meta\.env\.VITE_API_BASE_URL" "$JS_FILE"; then
            echo "WARNING: Environment variables might not be replaced in build"
          fi

          echo "API configuration validated"

      - name: Generate Build Summary
        run: |
          echo "========================================"
          echo "Build Summary"
          echo "========================================"
          echo "API URL: ${{ vars.VITE_API_BASE_URL }}"
          echo "Total files: $(find dist -type f | wc -l)"
          echo "Total size: $(du -sh dist | cut -f1)"
          echo "JS files: $(find dist/assets -name '*.js' | wc -l)"
          echo "CSS files: $(find dist/assets -name '*.css' | wc -l)"
          echo "Status: Ready for deployment"
          echo "========================================"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  # Verify backend has required API endpoints before deploying frontend
  backend-compatibility:
    runs-on: ubuntu-latest
    needs: build
    # Skip this check on manual dispatch if skip_backend_check is true
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_backend_check) }}
    steps:
      - name: Check Backend API Compatibility
        run: |
          API_URL="${{ vars.VITE_API_BASE_URL }}"
          if [ -z "$API_URL" ]; then
            echo "ERROR: VITE_API_BASE_URL is not set, cannot check backend"
            exit 1
          fi

          echo "========================================"
          echo "Backend API Compatibility Check"
          echo "========================================"
          echo "API URL: $API_URL"
          echo ""

          FAILED=0

          # 1. Check backend is reachable
          echo "--- Checking backend reachability ---"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}/v1/games" 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "000" ]; then
            echo "ERROR: Backend is not reachable at $API_URL"
            echo "Make sure the backend is deployed and accessible."
            exit 1
          fi
          echo "Backend reachable (HTTP $HTTP_CODE)"
          echo ""

          # 2. Check KYC image endpoint exists (new endpoint from recent changes)
          # We expect 401 (unauthorized) which means the route exists but requires auth
          echo "--- Checking admin KYC image endpoint ---"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}/v1/admin/kyc/image/test" 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "OK: /v1/admin/kyc/image/:filename exists (HTTP $HTTP_CODE - auth required, as expected)"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "ERROR: /v1/admin/kyc/image/:filename returns 404"
            echo "The backend does not have the new KYC image endpoint yet."
            echo "Deploy the backend first, then re-run this workflow."
            echo ""
            echo "To force-deploy anyway, use: Actions > Deploy to GitHub Pages > Run workflow > check 'Skip backend API compatibility check'"
            FAILED=1
          else
            echo "WARNING: /v1/admin/kyc/image/:filename returned HTTP $HTTP_CODE (expected 401/403)"
            echo "Endpoint may exist but returned an unexpected status. Proceeding with caution."
          fi
          echo ""

          # 3. Check KYC upload blocked (direct access should return 403)
          echo "--- Checking KYC uploads are protected ---"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL%/api}/uploads/kyc/test.jpg" 2>/dev/null || echo "000")
          if [ "$HTTP_CODE" = "403" ]; then
            echo "OK: Direct /uploads/kyc/ access blocked (HTTP 403)"
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "OK: /uploads/kyc/test.jpg returns 404 (file doesn't exist, but route is handled)"
          else
            echo "WARNING: /uploads/kyc/test.jpg returned HTTP $HTTP_CODE (expected 403)"
            echo "Direct KYC file access may not be properly blocked on the backend."
          fi
          echo ""

          echo "========================================"
          if [ "$FAILED" = "1" ]; then
            echo "COMPATIBILITY CHECK FAILED"
            echo "Deploy the backend before deploying the frontend."
            echo "Or use workflow_dispatch with 'Skip backend check' to override."
            echo "========================================"
            exit 1
          fi
          echo "All compatibility checks passed"
          echo "========================================"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    # Deploy after build succeeds AND either:
    # - backend-compatibility passed, OR
    # - backend-compatibility was skipped (manual dispatch with skip_backend_check)
    needs: [build, backend-compatibility]
    # Always run if build succeeded â€” backend-compatibility may have been skipped
    if: ${{ always() && needs.build.result == 'success' && (needs.backend-compatibility.result == 'success' || needs.backend-compatibility.result == 'skipped') }}
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  post-deployment-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Wait for deployment to propagate
        run: sleep 30

      - name: Health Check
        run: |
          SITE_URL="${{ needs.deploy.outputs.page_url }}"
          if [ -z "$SITE_URL" ]; then
            SITE_URL="https://skintrader.uz"
          fi
          # Remove trailing slash
          SITE_URL="${SITE_URL%/}"

          echo "Testing: $SITE_URL"

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "WARNING: Site returned HTTP $HTTP_CODE (may still be propagating)"
          else
            echo "Site is accessible (HTTP 200)"
          fi

          # Check if index.html is served
          if curl -s "$SITE_URL" | grep -q '<div id="root">'; then
            echo "index.html is being served correctly"
          else
            echo "WARNING: index.html might not be served correctly"
          fi

          # Check SPA routing
          HTTP_CODE_ROUTE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/posts" || echo "000")
          if [ "$HTTP_CODE_ROUTE" = "200" ]; then
            echo "SPA routing is working (/posts returns 200)"
          else
            echo "WARNING: /posts returned HTTP $HTTP_CODE_ROUTE"
          fi

          echo ""
          echo "========================================"
          echo "Deployment Complete!"
          echo "Site URL: $SITE_URL"
          echo "========================================"
