name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate Environment Variables
        run: |
          echo "ğŸ” Checking environment variables..."
          if [ -z "${{ vars.VITE_API_BASE_URL }}" ]; then
            echo "âŒ ERROR: VITE_API_BASE_URL is not set"
            echo "Please add it in: Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
            exit 1
          fi
          if [ -z "${{ vars.VITE_GOOGLE_CLIENT_ID }}" ]; then
            echo "âŒ ERROR: VITE_GOOGLE_CLIENT_ID is not set"
            echo "Please add it in: Settings â†’ Secrets and variables â†’ Actions â†’ Variables"
            exit 1
          fi
          echo "âœ… VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}"
          echo "âœ… VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}"

          # Check if API URL is not localhost
          if [[ "${{ vars.VITE_API_BASE_URL }}" == *"localhost"* ]]; then
            echo "âš ï¸  WARNING: API URL contains 'localhost' - this will fail in production!"
            echo "Expected format: https://api.skintrader.uz/api"
            exit 1
          fi
          echo "âœ… Environment variables validated"

      - name: Check for Common Code Issues
        run: |
          echo "ğŸ” Checking for potential code issues..."

          # Check for console.log in source files (should be removed in production)
          if grep -r "console\.log" src/ --include="*.jsx" --include="*.js" | grep -v "// " | grep -v "/\*"; then
            echo "âš ï¸  WARNING: Found console.log statements in code"
            echo "Consider removing them for production"
            # Don't fail, just warn
          fi

          # Check for hardcoded localhost URLs
          if grep -r "localhost" src/ --include="*.jsx" --include="*.js" | grep -v "api.js" | grep -v "//"; then
            echo "âŒ ERROR: Found hardcoded localhost URLs in code (excluding api.js)"
            exit 1
          fi

          # Check for TODO/FIXME comments
          if grep -r "TODO\|FIXME" src/ --include="*.jsx" --include="*.js" | head -5; then
            echo "âš ï¸  WARNING: Found TODO/FIXME comments - review before production"
            # Don't fail, just warn
          fi

          echo "âœ… Code quality checks passed"

      - name: Build
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}

      - name: Verify Build Output
        run: |
          echo "ğŸ” Checking build output..."
          ls -la dist/
          echo ""
          echo "ğŸ“‹ Verifying critical files exist..."
          test -f dist/index.html || (echo "âŒ index.html missing" && exit 1)
          test -f dist/_redirects || (echo "âŒ _redirects missing" && exit 1)
          test -f dist/.htaccess || (echo "âŒ .htaccess missing" && exit 1)
          test -f dist/404.html || (echo "âŒ 404.html missing" && exit 1)
          echo "âœ… All critical files present"
          echo ""
          echo "ğŸ“¦ Checking bundle size..."
          JS_SIZE=$(find dist/assets -name "*.js" -type f -exec du -ch {} + | grep total | cut -f1)
          CSS_SIZE=$(find dist/assets -name "*.css" -type f -exec du -ch {} + | grep total | cut -f1)
          echo "JavaScript bundle: $JS_SIZE"
          echo "CSS bundle: $CSS_SIZE"

          # Check if JS bundle is too large (warn if > 1MB)
          JS_BYTES=$(find dist/assets -name "*.js" -type f -exec stat -f%z {} + | awk '{s+=$1} END {print s}')
          if [ "$JS_BYTES" -gt 1048576 ]; then
            echo "âš ï¸  WARNING: JavaScript bundle is large (>1MB). Consider code splitting."
          fi
          echo "âœ… Build output verified"

      - name: Verify SPA Routing Configuration
        run: |
          echo "ğŸ” Verifying SPA routing files..."

          # Check _redirects content
          if ! grep -q "/\*.*index.html.*200" dist/_redirects; then
            echo "âŒ ERROR: _redirects file doesn't have correct SPA routing rule"
            cat dist/_redirects
            exit 1
          fi

          # Check .htaccess content
          if ! grep -q "RewriteEngine On" dist/.htaccess; then
            echo "âŒ ERROR: .htaccess file doesn't have rewrite rules"
            cat dist/.htaccess
            exit 1
          fi

          # Check 404.html has redirect script
          if ! grep -q "window.location" dist/404.html; then
            echo "âŒ ERROR: 404.html missing redirect script"
            exit 1
          fi

          echo "âœ… SPA routing configuration verified"

      - name: Check for Broken Imports
        run: |
          echo "ğŸ” Checking for potential broken imports..."

          # Verify main entry point exists in built files
          if ! grep -q "modulepreload" dist/index.html; then
            echo "âš ï¸  WARNING: index.html might not have proper module loading"
          fi

          # Check if index.html has the root div
          if ! grep -q '<div id="root">' dist/index.html; then
            echo "âŒ ERROR: index.html missing root div"
            exit 1
          fi

          echo "âœ… Import checks passed"

      - name: Validate API Configuration in Build
        run: |
          echo "ğŸ” Validating API configuration in built files..."

          # Extract the built JS file
          JS_FILE=$(find dist/assets -name "index-*.js" -type f | head -1)

          if [ -z "$JS_FILE" ]; then
            echo "âŒ ERROR: Could not find built JavaScript file"
            exit 1
          fi

          echo "Found built file: $JS_FILE"

          # Check if environment variable was replaced (should not contain VITE_API_BASE_URL as string)
          # This is a basic check - the build process should replace these
          if grep -q "import\.meta\.env\.VITE_API_BASE_URL" "$JS_FILE"; then
            echo "âš ï¸  WARNING: Environment variables might not be replaced in build"
            echo "This could indicate build configuration issue"
          fi

          echo "âœ… API configuration validated"

      - name: Generate Build Summary
        run: |
          echo "ğŸ“Š Build Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment:"
          echo "  â€¢ API URL: ${{ vars.VITE_API_BASE_URL }}"
          echo "  â€¢ Client ID: ${{ vars.VITE_GOOGLE_CLIENT_ID }}"
          echo ""
          echo "Build Output:"
          echo "  â€¢ Total files: $(find dist -type f | wc -l)"
          echo "  â€¢ Total size: $(du -sh dist | cut -f1)"
          echo "  â€¢ JS files: $(find dist/assets -name "*.js" | wc -l)"
          echo "  â€¢ CSS files: $(find dist/assets -name "*.css" | wc -l)"
          echo ""
          echo "Routing Configuration:"
          echo "  â€¢ _redirects: âœ…"
          echo "  â€¢ .htaccess: âœ…"
          echo "  â€¢ 404.html: âœ…"
          echo ""
          echo "Status: âœ… Ready for deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  post-deployment-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()
    steps:
      - name: Wait for deployment to propagate
        run: |
          echo "â³ Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Health Check
        run: |
          echo "ğŸ¥ Running post-deployment health checks..."

          SITE_URL="${{ needs.deploy.outputs.page_url }}"

          if [ -z "$SITE_URL" ]; then
            SITE_URL="https://skintrader.uz"
          fi

          echo "Testing: $SITE_URL"

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "âš ï¸  WARNING: Site returned HTTP $HTTP_CODE"
            echo "Site might not be accessible yet. Please check manually."
          else
            echo "âœ… Site is accessible (HTTP 200)"
          fi

          # Check if index.html is served
          if curl -s "$SITE_URL" | grep -q "<div id=\"root\">"; then
            echo "âœ… index.html is being served correctly"
          else
            echo "âš ï¸  WARNING: index.html might not be served correctly"
          fi

          # Check SPA routing (test a route)
          HTTP_CODE_ROUTE=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL/posts" || echo "000")

          if [ "$HTTP_CODE_ROUTE" = "200" ]; then
            echo "âœ… SPA routing is working (/posts returns 200)"
          else
            echo "âš ï¸  WARNING: SPA routing might not be working properly"
            echo "   /posts returned HTTP $HTTP_CODE_ROUTE"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Site URL: $SITE_URL"
          echo ""
          echo "ğŸ“‹ Post-Deployment Checklist:"
          echo "  [ ] Visit site and verify it loads"
          echo "  [ ] Test /create-post route"
          echo "  [ ] Check game selector shows games"
          echo "  [ ] Test login with Google"
          echo "  [ ] Create a test post"
          echo "  [ ] Check browser console for errors"
          echo ""
          echo "âš ï¸  Important: If games don't appear:"
          echo "  1. Login to admin panel: $SITE_URL/admin/login"
          echo "  2. Go to Games Management"
          echo "  3. Add games (CS2, Dota 2, PUBG, etc.)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
